{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "templateLocation": {
      "type": "String",
      "metadata": {
        "description": "URL for the container where the deployment templates are located."
      }
    },
    "templateLocationSasToken": {
      "type": "SecureString",
      "metadata": {
        "description": "SAS token for getting the deployment templates."
      }
    },
    "scriptContainerLocation": {
      "type": "String"
    },
    "scriptStorageSasToken": {
      "type": "SecureString"
    },
    "serverName": {
      "type": "String",
      "metadata": {
        "description": "The name of the server."
      }
    },
    "serverSize": {
      "defaultValue": "Standard_A1",
      "type": "String",
      "metadata": {
        "description": "The size of the server."
      }
    },
    "numDataDisks": {
      "allowedValues": [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8"
      ],
      "type": "String",
      "metadata": {
        "description": "The number of data disks."
      }
    },
    "dataDiskSizeGB": {
      "type": "Int",
      "metadata": {
        "description": "The size of the data disks in GB."
      }
    },
    "availabilitySetName": {
      "type": "String",
      "metadata": {
        "description": "The name of the availability set in which this server is to be placed."
      }
    },
    "availabilitySetId": {
      "type": "String",
      "metadata": {
        "description": "The id of the availability set in which this server is to be placed."
      }
    },
    "imagePublisher": {
      "defaultValue": "MicrosoftWindowsServer",
      "type": "String",
      "metadata": {
        "description": "The publisher of the image to deploy on the server."
      }
    },
    "imageOffer": {
      "defaultValue": "WindowsServer",
      "type": "String",
      "metadata": {
        "description": "The offer of the image to deploy on the server."
      }
    },
    "imageSKU": {
      "defaultValue": "2012-R2-Datacenter",
      "type": "String",
      "metadata": {
        "description": "The SKU of the image to deploy on the server.."
      }
    },
    "imageVersion": {
      "defaultValue": "7.2.20161026",
      "type": "String",
      "metadata": {
        "description": "The version number of the image to deploy on the server."
      }
    },
    "adminUserName": {
      "type": "String",
      "metadata": {
        "description": "The name of the administrator account for the server. No domain prefix must be supplied."
      }
    },
    "adminPassword": {
      "type": "SecureString",
      "metadata": {
        "description": "The password for the administrator account for the server."
      }
    },
    "storageAccountName": {
      "type": "String",
      "metadata": {
        "description": "The name of the storage account where the disks are to be stored."
      }
    },
    "storageAccountId": {
      "type": "String",
      "metadata": {
        "description": "The resource Id for the storage account where the disks are to be stored."
      }
    },
    "subnetId": {
      "type": "String",
      "metadata": {
        "description": "The resource Id for the subnet to which the VM is to be attached. The calling template should depend on the vnet that contains the subnet."
      }
    },
    "privateIPAllocationMethod": {
      "defaultValue": "Dynamic",
      "allowedValues": [
        "Static",
        "Dynamic"
      ],
      "type": "String",
      "metadata": {
        "description": "Defines how a private IP address is assigned. Options are Static or Dynamic."
      }
    },
    "ipAddress": {
      "type": "String",
      "metadata": {
        "description": "The static ip address of the server."
      }
    },
    "dnsSettings": {
      "defaultValue": {
        "dnsServers": [ ]
      },
      "type": "Object",
      "metadata": {
        "description": "The DNS settings to use, null to get them from the Vnet."
      }
    },
    "provisioningSubnetId": {
      "type": "String",
      "metadata": {
        "description": "Provisioning Subnet VNET Id."
      }
    },
    "diagStorageAccountName": {
      "type": "String",
      "metadata": {
        "description": "The name of the Diagnostic storage account."
      }
    },
    "configurationLocation": {
      "type": "String",
      "metadata": {
        "description": "URL for getting the DSC configuration."
      }
    },
    "configurationLocationSasToken": {
      "type": "SecureString",
      "metadata": {
        "description": "SAS token for getting the DSC configuration."
      }
    },
    "configKeyVaultResourceGroup": {
      "defaultValue": "",
      "type": "String",
      "metadata": {
        "description": "Name of the resource group containing the configuration key vault for the server type."
      }
    },
    "configKeyVaultName": {
      "defaultValue": "",
      "type": "String",
      "metadata": {
        "description": "Name of the key vault containing the secrets for the server type."
      }
    },
    "encKeyVaultName": {
      "defaultValue": "",
      "type": "String",
      "metadata": {
        "description": "Name of the key vault containing the encryption keys for the server type."
      }
    },
    "encKeyVaultResourceGroup": {
      "defaultValue": "",
      "type": "String",
      "metadata": {
        "description": "The encryption key vault resource group name."
      }
    },
    "encKekUrl": {
      "defaultValue": "",
      "type": "String",
      "metadata": {
        "description": "The KEK url."
      }
    },
    "encryptionTemplateVariation": {
      "defaultValue": "",
      "type": "String",
      "metadata": {
        "description": "The encryption template variation."
      }
    }
  },
  "variables": {
    "serverId": "[resourceId('Microsoft.Compute/virtualMachines/', parameters('serverName'))]",
    "serverNicName": "[concat(parameters('serverName'), '-pnic0')]",
    "serverNicID": "[resourceId('Microsoft.Network/networkInterfaces/', variables('serverNicName'))]",
    "serverProvNicName": "[concat(parameters('serverName'), '-prvnic0')]",
    "serverProvNicID": "[resourceId('Microsoft.Network/networkInterfaces/', variables('serverProvNicName'))]",
    "updateVMTemplateNicName": "UpdateVmTemplateNicUpdate",
    "updateVMNicTemplate": "[concat(parameters('templateLocation'), '/', variables('updateVMTemplateNicName'), '.json', parameters('templateLocationSasToken'))]",
    "serverOsDiskName": "[concat(parameters('serverName'), '-osdisk')]",
    "vhdStorageAccountContainerName": "[concat(toLower(resourceGroup().name), '-vhd')]",
    "diskSelectionTemplate": "[concat(parameters('templateLocation'), '/', 'DataDisksTemplate.json', parameters('templateLocationSasToken'))]",
    "diskSelectionDeploymentName": "[concat('DiskSelection-', uniqueString(resourceGroup().id, deployment().name))]",
    "diskSelectionTemplateId": "[resourceId('Microsoft.Resources/deployments/', variables('diskSelectionDeploymentName'))]",
    "EncryptionTemplateName": "EncryptionTemplate",
    "actualEncryptionTemplate": "[concat(parameters('templateLocation'), '/', variables('EncryptionTemplateName'), parameters('encryptionTemplateVariation'), '.json', parameters('templateLocationSasToken'))]",
    "ChefTemplateName": "ChefBootstrapTemplate",
    "AdJoinTemplateName": "AdJoinTemplate",
    "linuxAgentTemplateName": "LinuxAgentTemplate",
    "linuxAgentTemplate": "[concat(parameters('templateLocation'), '/', variables('linuxAgentTemplateName'), '.json', parameters('templateLocationSasToken'))]",
    "hostConfigName": "[concat(parameters('serverName'))]",
    "scriptName": "linux-deploy.sh",
    "scriptNameParam": "[concat(variables('hostConfigName'), '.conf')]",
    "adJoinName": "domain-join.sh",
    "scriptLocation": "[concat(parameters('scriptContainerLocation'), '/', variables('scriptName'), parameters('scriptStorageSasToken'))]",
    "scriptParamLocation": "[concat(parameters('scriptContainerLocation'), '/', variables('scriptNameParam'), parameters('scriptStorageSasToken'))]",
    "adJoinNameLocation": "[concat(parameters('scriptContainerLocation'), '/', variables('adJoinName'), parameters('scriptStorageSasToken'))]",
    "diskScriptName": "datadisk.sh",
    "diskScriptLocation": "[concat(parameters('scriptContainerLocation'), '/', variables('diskScriptName'), parameters('scriptStorageSasToken'))]",
    "sccmScriptName": "sccm-install.sh",
    "sccmScriptLocation": "[concat(parameters('scriptContainerLocation'), '/', variables('sccmScriptName'), parameters('scriptStorageSasToken'))]",
    "sccmInstallScript": "sccm_install",
    "sccmInstallScriptLocation": "[concat(parameters('scriptContainerLocation'), '/', variables('sccmInstallScript'), parameters('scriptStorageSasToken'))]",
    "sccmClient": "ccm-Universalx64.tar"
    
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[variables('diskSelectionDeploymentName')]",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('diskSelectionTemplate')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "numDataDisks": {
            "value": "[parameters('numDataDisks')]"
          },
          "diskNameRoot": {
            "value": "[parameters('serverName')]"
          },
          "diskStorageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "diskStorageAccountContainerName": {
            "value": "[variables('vhdStorageAccountContainerName')]"
          },
          "diskCaching": {
            "value": "ReadWrite"
          },
          "diskSizeGB": {
            "value": "[parameters('dataDiskSizeGB')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('serverNicName')]",
      "apiVersion": "2016-03-30",
      "location": "[resourceGroup().location]",
    
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "[parameters('privateIPAllocationMethod')]",
              "privateIPAddress": "[parameters('ipAddress')]",
              "subnet": {
                "id": "[parameters('subnetId')]"
              }
            }
          }
        ],
        "dnsSettings": "[parameters('dnsSettings')]"
      },
      "dependsOn": [ ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[parameters('serverName')]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
    
      "properties": {
        "availabilitySet": {
          "id": "[parameters('availabilitySetId')]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('serverSize')]"
        },
        "osProfile": {
          "computerName": "[parameters('serverName')]",
          "adminUsername": "[parameters('adminUserName')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('imagePublisher')]",
            "offer": "[parameters('imageOffer')]",
            "sku": "[parameters('imageSKU')]",
            "version": "[parameters('imageVersion')]"
          },
          "osDisk": {
            "name": "[variables('serverOsDiskName')]",
            "vhd": {
              "uri": "[concat('http://', parameters('storageAccountName'), '.blob.core.windows.net/', variables('vhdStorageAccountContainerName'), '/', variables('serverOsDiskName'), '.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": "[reference(variables('diskSelectionDeploymentName')).outputs.dataDiskArray.value]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[variables('serverProvNicID')]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": true,
            "storageUri": "[concat('http://', parameters('diagStorageAccountName'), '.blob.core.windows.net')]"
          }
        }
      },
      "dependsOn": [
        "[variables('serverNicID')]",
        "[variables('serverProvNicID')]",
        "[variables('diskSelectionTemplateId')]"
      ]
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('serverProvNicName')]",
      "apiVersion": "2016-03-30",
      "location": "[resourceGroup().location]",
      
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfigPrv",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "privateIPAddress": "0.0.0.0",
              "subnet": {
                "id": "[parameters('provisioningSubnetId')]"
              }
            }
          }
        ],
        "dnsSettings": "[parameters('dnsSettings')]"
      },
      "dependsOn": [ ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[concat(parameters('serverName'),'-Encrypt')]",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('actualEncryptionTemplate')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
        
         
        
          "vmName": {
            "value": "[parameters('serverName')]"
          },
          "aadClientID": {
            "reference": {
              "keyVault": {
                "id": "[resourceId(parameters('configKeyVaultResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('configKeyVaultName'))]"
              },
              "secretName": "AzureAdAppId"
            }
          },
          "aadClientSecret": {
            "reference": {
              "keyVault": {
                "id": "[resourceId(parameters('configKeyVaultResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('configKeyVaultName'))]"
              },
              "secretName": "AzureAdAppKey"
            }
          },
          "keyVaultName": {
            "value": "[parameters('encKeyVaultName')]"
          },
          "keyVaultResourceGroup": {
            "value": "[parameters('encKeyVaultResourceGroup')]"
          },
          "useExistingKek": {
            "value": "Kek"
          },
          "keyEncryptionKeyURL": {
            "value": "[parameters('encKekUrl')]"
          },
          "templateLocation": {
            "value": "[parameters('templateLocation')]"
          },
          "templateLocationSasToken": {
            "value": "[parameters('templateLocationSasToken')]"
          }
        }
      },
      "dependsOn": [
        "[variables('serverId')]",
        "[resourceId('Microsoft.Resources/deployments', concat(parameters('serverName'), '-linuxAgent'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[concat(parameters('serverName'),'-UpdateVM')]",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('updateVMNicTemplate')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "primaryServerNicID": {
            "value": "[variables('serverNicID')]"
          },
          "vmName": {
            "value": "[parameters('serverName')]"
          }
        }
      },
      "dependsOn": [
        "[variables('serverId')]",
        "[resourceId('Microsoft.Resources/deployments', concat(parameters('serverName'), '-Encrypt'))]"
      ]
    }
  ],
  "outputs": {
    "ServerId": {
      "type": "String",
      "value": "[variables('serverId')]"
    }
  }
}